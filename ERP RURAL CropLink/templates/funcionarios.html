{% extends "base.html" %}

{% block title %}Funcionários - CropLink{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <h1 class="display-6">
                <i class="fas fa-users text-success"></i>
                Gestão de Funcionários
            </h1>
            <p class="text-muted">Controle de funcionários fixos e informações trabalhistas</p>
        </div>
        <div class="col-auto">
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalAdicionarFuncionario">
                <i class="fas fa-plus"></i> Adicionar Funcionário
            </button>
        </div>
    </div>

    <!-- Lista de Funcionários -->
    <div class="card shadow">
        <div class="card-body">
            {% if funcionarios %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th style="width: 25%;">Nome Completo</th>
                                <th style="width: 15%;" class="text-center-td">CPF</th>
                                <th style="width: 15%;" class="text-center-td">Telefone</th>
                                <th style="width: 15%;" class="text-center-td">Cargo</th>
                                <th style="width: 12%;" class="text-center-td">Data Admissão</th>
                                <th style="width: 10%;" class="text-center-td">Status</th>
                                <th style="width: 8%;" class="text-center-td">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for funcionario in funcionarios %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-user-tie text-success me-2"></i>
                                        <span class="fw-semibold">{{ funcionario.nome_completo }}</span>
                                    </div>
                                </td>
                                <td class="text-center-td">
                                    {% if funcionario.cpf %}
                                        <span class="contact-cell">{{ funcionario.cpf }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-center-td">
                                    {% if funcionario.telefone %}
                                        <span class="contact-cell">{{ funcionario.telefone }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-center-td">
                                    {% if funcionario.cargo %}
                                        <span class="badge bg-primary">{{ funcionario.cargo }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-center-td">
                                    {% if funcionario.data_admissao %}
                                        <span>{{ funcionario.data_admissao.strftime('%d/%m/%Y') }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-center-td">
                                    {% if funcionario.data_admissao %}
                                        <span class="badge status-active">
                                            <i class="fas fa-check-circle me-1"></i>Ativo
                                        </span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-sm btn-outline-primary" onclick="editarFuncionario({{ funcionario.id }}, '{{ funcionario.nome_completo }}', '{{ funcionario.cpf }}', '{{ funcionario.telefone }}', '{{ funcionario.cargo }}', '{{ funcionario.data_admissao.strftime('%Y-%m-%d') if funcionario.data_admissao else '' }}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="excluirFuncionario({{ funcionario.id }}, '{{ funcionario.nome_completo }}')" title="Excluir funcionário">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-users fa-3x text-muted mb-3"></i>
                    <p class="text-muted">Nenhum funcionário cadastrado ainda.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal Adicionar Funcionário -->
<div class="modal fade" id="modalAdicionarFuncionario" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Adicionar Funcionário</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('adicionar_funcionario') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="nome_completo" class="form-label">Nome Completo *</label>
                        <input type="text" class="form-control" id="nome_completo" name="nome_completo" required placeholder="Nome completo do funcionário">
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <label for="cpf" class="form-label">CPF</label>
                            <input type="text" class="form-control" id="cpf" name="cpf" placeholder="000.000.000-00" maxlength="14">
                        </div>
                        <div class="col-md-6">
                            <label for="telefone" class="form-label">Telefone</label>
                            <input type="text" class="form-control" id="telefone" name="telefone" placeholder="(00) 00000-0000">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <label for="cargo" class="form-label">Cargo</label>
                            <select class="form-select" id="cargo" name="cargo">
                                <option value="">Selecione o cargo</option>
                                <option value="Operador de Máquinas">Operador de Máquinas</option>
                                <option value="Trabalhador Rural">Trabalhador Rural</option>
                                <option value="Supervisor">Supervisor</option>
                                <option value="Mecânico">Mecânico</option>
                                <option value="Administrativo">Administrativo</option>
                                <option value="Gerente">Gerente</option>
                                <option value="Outros">Outros</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="data_admissao" class="form-label">Data de Admissão</label>
                            <input type="date" class="form-control" id="data_admissao" name="data_admissao">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">Adicionar Funcionário</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Editar Funcionário -->
<div class="modal fade" id="modalEditarFuncionario" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar Funcionário</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="formEditarFuncionario">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editNomeCompleto" class="form-label">Nome Completo *</label>
                        <input type="text" class="form-control" id="editNomeCompleto" name="nome_completo" required>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <label for="editCpf" class="form-label">CPF</label>
                            <input type="text" class="form-control" id="editCpf" name="cpf" maxlength="14">
                        </div>
                        <div class="col-md-6">
                            <label for="editTelefone" class="form-label">Telefone</label>
                            <input type="text" class="form-control" id="editTelefone" name="telefone">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <label for="editCargo" class="form-label">Cargo</label>
                            <select class="form-select" id="editCargo" name="cargo">
                                <option value="">Selecione o cargo</option>
                                <option value="Operador de Máquinas">Operador de Máquinas</option>
                                <option value="Trabalhador Rural">Trabalhador Rural</option>
                                <option value="Supervisor">Supervisor</option>
                                <option value="Mecânico">Mecânico</option>
                                <option value="Administrativo">Administrativo</option>
                                <option value="Gerente">Gerente</option>
                                <option value="Outros">Outros</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="editDataAdmissao" class="form-label">Data de Admissão</label>
                            <input type="date" class="form-control" id="editDataAdmissao" name="data_admissao">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Máscara para CPF
document.getElementById('cpf').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    value = value.replace(/(\d{3})(\d)/, '$1.$2');
    value = value.replace(/(\d{3})(\d)/, '$1.$2');
    value = value.replace(/(\d{3})(\d{1,2})/, '$1-$2');
    e.target.value = value;
});

// Máscara para telefone
document.getElementById('telefone').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    value = value.replace(/(\d{2})(\d)/, '($1) $2');
    value = value.replace(/(\d{4,5})(\d{4})/, '$1-$2');
    e.target.value = value;
});

function editarFuncionario(id, nome, cpf, telefone, cargo, dataAdmissao) {
    document.getElementById('editNomeCompleto').value = nome;
    document.getElementById('editCpf').value = cpf || '';
    document.getElementById('editTelefone').value = telefone || '';
    document.getElementById('editCargo').value = cargo || '';
    document.getElementById('editDataAdmissao').value = dataAdmissao || '';
    
    document.getElementById('formEditarFuncionario').action = '/funcionarios/editar/' + id;
    
    new bootstrap.Modal(document.getElementById('modalEditarFuncionario')).show();
}

function excluirFuncionario(id, nome) {
    if (confirm(`Tem certeza que deseja excluir o funcionário "${nome}"?`)) {
        // Criar formulário para submeter POST com CSRF token
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/funcionarios/excluir/${id}`;
        form.style.display = 'none';
        
        // Adicionar CSRF token
        const csrfToken = document.querySelector('meta[name=csrf-token]');
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = csrfToken.getAttribute('content');
            form.appendChild(csrfInput);
        }
        
        document.body.appendChild(form);
        form.submit();
    }
}

// Aplicar máscaras nos campos de edição também
document.addEventListener('DOMContentLoaded', function() {
    // Máscara para CPF de edição
    document.getElementById('editCpf').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        value = value.replace(/(\d{3})(\d)/, '$1.$2');
        value = value.replace(/(\d{3})(\d)/, '$1.$2');
        value = value.replace(/(\d{3})(\d{1,2})/, '$1-$2');
        e.target.value = value;
    });

    // Máscara para telefone de edição
    document.getElementById('editTelefone').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        value = value.replace(/(\d{2})(\d)/, '($1) $2');
        value = value.replace(/(\d{4,5})(\d{4})/, '$1-$2');
        e.target.value = value;
    });
});
</script>
{% endblock %}
