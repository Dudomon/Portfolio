# EMERGENCY SL FIX - Aplicar no daytrader.py

# LOCALIZAÃ‡ÃƒO: FunÃ§Ã£o step(), logo apÃ³s "# ðŸš€ VERIFICAR SL/TP AUTOMÃTICO"

# SUBSTITUIR:
for pos in self.positions[:]:  # Usar slice para evitar modificaÃ§Ã£o durante iteraÃ§Ã£o
    should_close = False
    close_reason = ""
    
    if 'sl' in pos and pos['sl'] > 0:
        if pos['type'] == 'long' and current_price <= pos['sl']:
            should_close = True
            close_reason = "SL hit"
        elif pos['type'] == 'short' and current_price >= pos['sl']:
            should_close = True
            close_reason = "SL hit"

# POR:
for pos in self.positions[:]:  # Usar slice para evitar modificaÃ§Ã£o durante iteraÃ§Ã£o
    should_close = False
    close_reason = ""
    
    # ðŸš¨ EMERGENCY FIX: VerificaÃ§Ã£o extra de SL
    if 'sl' not in pos or pos['sl'] <= 0:
        print(f"ðŸš¨ POSIÃ‡ÃƒO SEM SL VÃLIDO: {pos.get('type', 'unknown')} entry={pos.get('entry_price', 'N/A')}")
        # Fechar posiÃ§Ã£o por seguranÃ§a
        should_close = True
        close_reason = "Emergency close - no SL"
    else:
        # VerificaÃ§Ã£o normal de SL
        if pos['type'] == 'long' and current_price <= pos['sl']:
            should_close = True
            close_reason = "SL hit"
        elif pos['type'] == 'short' and current_price >= pos['sl']:
            should_close = True
            close_reason = "SL hit"
        
        # ðŸš¨ EMERGENCY FIX: PnL safety check
        current_pnl = self._get_position_pnl(pos, current_price)
        max_loss_allowed = 10 * pos.get('lot_size', 0.01) * 100  # 10 pontos mÃ¡x
        
        if current_pnl < -max_loss_allowed:
            print(f"ðŸš¨ EMERGENCY STOP: PnL=${current_pnl:.2f} > Max=${max_loss_allowed:.2f}")
            should_close = True
            close_reason = "Emergency stop - excessive loss"

# ADICIONAR TAMBÃ‰M no final da verificaÃ§Ã£o:
    if should_close:
        print(f"ðŸŽ¯ Fechando posiÃ§Ã£o: {close_reason}, PnL=${self._get_position_pnl(pos, current_price):.2f}")
        self._close_position(pos, self.current_step)
        action_taken = True